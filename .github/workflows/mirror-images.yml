name: mirror-alpine-to-ghcr

on:
  workflow_dispatch:
  schedule:
    - cron: "23 3 * * *"  # daily

concurrency:
  group: mirror-images-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (optional, avoids anonymous pull limits)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${DOCKERHUB_USERNAME}" && -n "${DOCKERHUB_TOKEN}" ]]; then
            echo "${DOCKERHUB_TOKEN}" | docker login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin
          else
            echo "DOCKERHUB_USERNAME/DOCKERHUB_TOKEN not set; proceeding without Docker Hub login."
          fi

      - name: Login to GHCR (uses built-in GITHUB_TOKEN)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Mirror alpine:latest (optional)
        run: |
          set -euo pipefail

          SRC="docker.io/library/alpine:latest"
          DST="ghcr.io/${{ github.repository_owner }}/alpine:latest"
          docker buildx imagetools create --tag "$DST" "$SRC"

          SRC_DIGEST="$(docker buildx imagetools inspect --format '{{.manifest.digest}}' "$SRC")"
          DST_DIGEST="$(docker buildx imagetools inspect --format '{{.manifest.digest}}' "$DST")"
          echo "SRC digest: $SRC_DIGEST"
          echo "DST digest: $DST_DIGEST"
          test "$SRC_DIGEST" = "$DST_DIGEST"